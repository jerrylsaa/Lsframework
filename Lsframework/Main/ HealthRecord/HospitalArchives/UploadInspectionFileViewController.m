//
//  UploadInspectionFileViewController.m
//  FamilyPlatForm
//
//  Created by Shuai on 16/4/24.
//  Copyright ¬© 2016Âπ¥ Ê¢ÅÁªßÊòé. All rights reserved.
//

#import "UploadInspectionFileViewController.h"
#import "FPDatePicker.h"
#import "BSCheckProjectViewController.h"
#import "CorePhotoPickerVCManager.h"
#import "CheckHospitalViewController.h"
#import "UploadInspectionFilePresenter.h"
#import<Photos/Photos.h>

@interface UploadInspectionFileViewController ()<UINavigationControllerDelegate, UIImagePickerControllerDelegate, UITextFieldDelegate, UITextViewDelegate, UIActionSheetDelegate, upCheckFileDelegate, UIAlertViewDelegate>
{
    FPDatePicker *_datePicker;
    UIAlertController *_alert;
    NSTimer *_timer;
    NSString *myType;
    NSMutableArray *_selectedPhotoArray;
    
    NSInteger _hospitalID;
    NSInteger _projectID;
    NSString *_timeStr;
}

@property (weak, nonatomic) IBOutlet UILabel            *hospitalNameLabel;// ÂåªÈô¢ÂêçÂ≠ó
@property (weak, nonatomic) IBOutlet UIButton           *hospiNameBtn;// ÂåªÈô¢
@property (weak, nonatomic) IBOutlet UILabel            *dateTimeLabel;// Êó•Êúü
@property (weak, nonatomic) IBOutlet UIButton           *dateTimeBtn;// Êó•Êúü
@property (weak, nonatomic) IBOutlet UIButton           *upLoadBtn;// ‰∏ä‰º†
@property (weak, nonatomic) IBOutlet UILabel            *thirdViewLabel;// Á¨¨‰∏âË°åÁöÑÊñáÂ≠ó
@property (weak, nonatomic) IBOutlet UITextField        *thirdViewTF;// Á¨¨‰∏âË°åÁöÑËæìÂÖ•Ê°Ü
@property (weak, nonatomic) IBOutlet UIImageView        *rightImageView;// Á¨¨‰∏âË°åÁöÑÁÆ≠Â§¥
@property (weak, nonatomic) IBOutlet UIButton           *thirdViewBtn;// Á¨¨‰∏âË°åÊåâÈíÆ
@property (weak, nonatomic) IBOutlet UILabel            *fourthViewLabel;// Á¨¨ÂõõË°åÊñáÂ≠ó
@property (weak, nonatomic) IBOutlet UILabel            *fourthViewPlaceholder;// Á¨¨ÂõõË°åPlaceholder
@property (weak, nonatomic) IBOutlet UITextView         *fourthViewTV;// Á¨¨ÂõõË°åËæìÂÖ•Ê°Ü
@property (weak, nonatomic) IBOutlet NSLayoutConstraint *fourthViewTVHeight;// Á¨¨ÂõõË°åËæìÂÖ•ÁãÇÈ´òÂ∫¶

@property (nonatomic, strong) UploadInspectionFilePresenter *presenter;

@end

@implementation UploadInspectionFileViewController

- (void)viewDidLoad {
    [super viewDidLoad];
    // Do any additional setup after loading the view from its nib.
}

- (void)setupView {
    
    NSUserDefaults *user = [NSUserDefaults standardUserDefaults];
    myType = [user objectForKey:@"bsArchivesType"];
    
    if ([myType isEqualToString:@"0"]) {
        self.title = @"‰∏ä‰º†Ê£ÄÊü•Ê°£Ê°à";
        _rightImageView.hidden = NO;
        _thirdViewBtn.hidden = NO;
        
    }else if ([myType isEqualToString:@"1"]) {
        self.title = @"‰∏ä‰º†ÁóÖÂéÜÊ°£Ê°à";
        _thirdViewLabel.text = @"‰∏ªËØâÔºö";
        _thirdViewTF.hidden = NO;
        _thirdViewTF.delegate = self;
        _fourthViewLabel.text = @"ÂÜÖÂÆπ:";
        _fourthViewPlaceholder.text = @"ËØ∑ÊèèËø∞ÊÇ®ÁöÑÁóÖÊÉÖ‰ø°ÊÅØÔºåÊàñÊ≤ªÁñóÁªèËøá";
        [_upLoadBtn setTitle:@"ÁÇπÂáª‰∏ä‰º†ÁóÖÂéÜÂõæÁâá" forState:UIControlStateNormal];
        
    }
    _fourthViewTV.delegate = self;
    
}

- (IBAction)btnAction:(id)sender {
    
    UIButton *btn = (UIButton *)sender;
    if ([btn isEqual:_dateTimeBtn]) {
        NSLog(@"ÊÇ®ÁÇπÂáª‰∫ÜÊó•Êúü");
        
        __weak typeof(self) weakSelf = self;
        FPDatePicker * datePicker = [FPDatePicker new];
        [datePicker setMaxDate:[NSDate date]];
        [datePicker showInView:self.view];
        [datePicker addDatePickerHandler:^(NSString *date, NSDate * d) {
            
            NSLog(@"%@",date);
            
            weakSelf.dateTimeLabel.text = [NSString stringWithFormat:@"ÊÇ®ÊâÄÊ£ÄÊü•ÁöÑÊó•Êúü    %@", date];
            _timeStr = date;
            NSDate *myDate = [self showDate:date];
            NSLog(@"Ô£øÔ£øÔ£øÔ£øÔ£øÔ£øÔ£øÔ£øÔ£øÔ£øÔ£øÔ£øÔ£øÔ£øÔ£øÔ£øÔ£ø%@Ô£øÔ£øÔ£øÔ£øÔ£øÔ£øÔ£øÔ£øÔ£øÔ£øÔ£øÔ£ø", myDate);
            
        }];
    }else if ([btn isEqual:_thirdViewBtn]) {
        NSLog(@"ÊÇ®ÁÇπÂáª‰∫ÜÈ°πÁõÆ");
        BSCheckProjectViewController *vc = [[BSCheckProjectViewController alloc] init];
        vc.sendName = ^(NSString *name, NSInteger num){
            
            _thirdViewLabel.text = [NSString stringWithFormat:@"ÊÇ®ÊâÄÊ£ÄÊü•ÁöÑÈ°πÁõÆ    %@", name];
            NSLog(@"È°πÁõÆÂêçÁß∞idÔºö%ld", num);
            _projectID = num;
        };
        
        [self.navigationController pushViewController:vc animated:YES];
    }else if (btn == _hospiNameBtn) {
        CheckHospitalViewController *vc = [[CheckHospitalViewController alloc] init];
        vc.sendName = ^(NSString *name, NSInteger num){
            
            _hospitalNameLabel.text = [NSString stringWithFormat:@"ÊÇ®ÊâÄÊ£ÄÊü•ÁöÑÂåªÈô¢    %@", name];
            NSLog(@"È°πÁõÆÂêçÁß∞idÔºö%ld", num);
            _hospitalID = num;
        };
        
        [self.navigationController pushViewController:vc animated:YES];
    }else if ([btn isEqual:_upLoadBtn]) {
        NSLog(@"ÊÇ®ÁÇπÂáª‰∫Ü‰∏ä‰º†");
        [_fourthViewTV resignFirstResponder];
        
        _selectedPhotoArray = [NSMutableArray array];
        
        if ([myType isEqualToString:@"0"]) {
            if (_hospitalNameLabel.text.length > 7 && _dateTimeLabel.text.length > 7 && _thirdViewLabel.text.length > 7) {
                
                [self showSheet];
                
            }else {
                
                _alert = [UIAlertController alertControllerWithTitle:@"ÊèêÁ§∫" message:@"ËØ∑Â°´ÂÜôÂÆåÊï¥‰ø°ÊÅØ" preferredStyle:UIAlertControllerStyleAlert];
                [self presentViewController:_alert animated:YES completion:nil];
                
                _timer = [NSTimer scheduledTimerWithTimeInterval:2.0f target:self selector:@selector(timerFired) userInfo:nil repeats:NO];
                
            }
            
        }else if ([myType isEqualToString:@"1"]) {
            if (_hospitalNameLabel.text.length > 7 && _dateTimeLabel.text.length > 7 && _thirdViewTF.text.length > 0) {
                
                [self showSheet];
                
            }else {
                
                _alert = [UIAlertController alertControllerWithTitle:@"ÊèêÁ§∫" message:@"ËØ∑Â°´ÂÜôÂÆåÊï¥‰ø°ÊÅØ" preferredStyle:UIAlertControllerStyleAlert];
                [self presentViewController:_alert animated:YES completion:nil];
                
                _timer = [NSTimer scheduledTimerWithTimeInterval:2.0f target:self selector:@selector(timerFired) userInfo:nil repeats:NO];
                
            }
            
        }
        
    }
    
}

- (void)uploadData {
    
    self.presenter = [[UploadInspectionFilePresenter alloc] init];
    self.presenter.delegate = self;
    [ProgressUtil show];
    
    if ([myType isEqualToString:@"0"]) {
        
        NSLog(@"üòáüòáüòáüòá%ld\n%@\n%ld\n%@", _hospitalID, _timeStr, _projectID, _fourthViewTV.text);
        
        [self.presenter requestWithHospitalID:_hospitalID withTimeStr:_timeStr withProjectID:_projectID withOther:_fourthViewTV.text withPhotoArary:_selectedPhotoArray];
    }else if ([myType isEqualToString:@"1"]) {
        
        NSLog(@"üòáüòáüòáüòá%ld\n%@\n%@\n%@", _hospitalID, _timeStr, _thirdViewTF.text, _fourthViewTV.text);
        
        [self.presenter requestWithHospitalID:_hospitalID withTimeStr:_timeStr withComplained:_thirdViewTF.text withOther:_fourthViewTV.text withPhotoArary:_selectedPhotoArray];
    }
    
}

- (void)showSheet {
    
    if([[[UIDevice currentDevice] systemVersion] floatValue]  >= 8.0) {
        
        UIAlertController *alert = [UIAlertController alertControllerWithTitle:nil message:nil preferredStyle:UIAlertControllerStyleActionSheet];
        
        UIAlertAction *uploadPhotos = [UIAlertAction actionWithTitle:@"‰∏ä‰º†ÁÖßÁâá" style:UIAlertActionStyleDefault handler:^(UIAlertAction * _Nonnull action) {
            NSLog(@"‰∏ä‰º†ÁÖßÁâá");
            [self pickPhoto];
        }];
        
        UIAlertAction *uploadPhotosByCamera = [UIAlertAction actionWithTitle:@"ÊãçÁÖß‰∏ä‰º†" style:UIAlertActionStyleDefault handler:^(UIAlertAction * _Nonnull action) {
            NSLog(@"ÊãçÁÖß‰∏ä‰º†");
            [self takePhoto];
        }];
        
        UIAlertAction *cancelAction = [UIAlertAction actionWithTitle:@"ÂèñÊ∂à" style:UIAlertActionStyleCancel handler:nil];
        [alert addAction:uploadPhotos];
        [alert addAction:uploadPhotosByCamera];
        [alert addAction:cancelAction];
        [self presentViewController:alert animated:YES completion:nil];
        
    }else {
        
        UIActionSheet* sheet=[[UIActionSheet alloc] initWithTitle:nil delegate:self cancelButtonTitle:@"ÂèñÊ∂à" destructiveButtonTitle:nil otherButtonTitles:@"‰∏ä‰º†ÁÖßÁâá", @"ÊãçÁÖß‰∏ä‰º†", nil];
        [sheet showInView:self.view];
        
    }
    
}

- (void)actionSheet:(UIActionSheet *)actionSheet clickedButtonAtIndex:(NSInteger)buttonIndex
{
    if (buttonIndex == 0) {
        NSLog(@"‰∏ä‰º†ÁÖßÁâá1");
        [self pickPhoto];
    }else if (buttonIndex == 1) {
        NSLog(@"ÊãçÁÖß‰∏ä‰º†1");
        [self takePhoto];
    }else if (buttonIndex == 2) {
        NSLog(@"ÂèñÊ∂à");
    }
}

- (NSDate *)showDate:(NSString *)dateStr {
    
    NSDateFormatter *format=[[NSDateFormatter alloc] init];
    [format setDateFormat:@"yyyy-MM-dd"];
    NSDate *fromdate=[format dateFromString:dateStr];
    NSTimeZone *fromzone = [NSTimeZone systemTimeZone];
    NSInteger frominterval = [fromzone secondsFromGMTForDate: fromdate];
    NSDate *myDate = [fromdate  dateByAddingTimeInterval: frominterval];
    NSLog(@"myDate = %@",myDate);
    return myDate;
    
}

- (BOOL)textField:(UITextField *)textField shouldChangeCharactersInRange:(NSRange)range replacementString:(NSString *)string {
    
    if ([_thirdViewTF isEqual:textField]) {
        if (range.location >= 15) {
            return NO;
        }
    }
    return YES;
    
}

-(void)textViewDidChange:(UITextView *)textView {
    
    if ([textView.text isEqualToString:@""]) {
        _fourthViewPlaceholder.hidden = NO;
    }else {
        _fourthViewPlaceholder.hidden = YES;
    }
    CGFloat width = CGRectGetWidth(textView.frame);
    CGSize newSize = [textView sizeThatFits:CGSizeMake(width,MAXFLOAT)];
    _fourthViewTVHeight.constant = newSize.height;
    
}

- (void)timerFired {
    [_alert dismissViewControllerAnimated:YES completion:nil];
    [_timer invalidate];
}

-(void)takePhoto
{
    UIImagePickerControllerSourceType sourceType = UIImagePickerControllerSourceTypeCamera;
    if ([UIImagePickerController isSourceTypeAvailable: UIImagePickerControllerSourceTypeCamera])
    {
        UIImagePickerController *picker = [[UIImagePickerController alloc] init];
        picker.delegate = self;
        //ËÆæÁΩÆÊãçÁÖßÂêéÁöÑÂõæÁâáÂèØË¢´ÁºñËæë
        picker.allowsEditing = YES;
        picker.sourceType = sourceType;
        [self presentViewController:picker animated:YES completion:nil];
    }else
    {
        NSLog(@"Ê®°ÊãüÂÖ∂‰∏≠Êó†Ê≥ïÊâìÂºÄÁÖßÁõ∏Êú∫,ËØ∑Âú®ÁúüÊú∫‰∏≠‰ΩøÁî®");
    }
}

- (void)imagePickerController:(UIImagePickerController *)picker didFinishPickingMediaWithInfo:(NSDictionary *)info
{
    [picker dismissViewControllerAnimated:YES completion:^{
        
    }];
    
    UIImage *image = [info objectForKey:UIImagePickerControllerOriginalImage];
    
    [_selectedPhotoArray addObject:image];
    [self uploadData];
    
}

-(void)pickPhoto{
    
    PHAuthorizationStatus status = [PHPhotoLibrary authorizationStatus];
    if(status == PHAuthorizationStatusDenied || status ==PHAuthorizationStatusRestricted){
        
        NSLog(@"‰∏çÂÖÅËÆ∏ËÆøÈóÆ");
        //Êó†ÊùÉÈôê
        // Ëé∑ÂèñÂΩìÂâçAppÁöÑÂü∫Êú¨‰ø°ÊÅØÂ≠óÂÖ∏
        NSDictionary *infoDictionary = [[NSBundle mainBundle] infoDictionary];
        //appÂêçÁß∞
        NSString *app_Name = [infoDictionary objectForKey:@"CFBundleName"];
        NSString *tips = [NSString stringWithFormat:@"ËØ∑Âú®iPhoneÁöÑ‚ÄúËÆæÁΩÆ-ÈöêÁßÅ-ÁÖßÁâá‚ÄùÈÄâÈ°π‰∏≠ÔºåÂÖÅËÆ∏%@ËÆøÈóÆ‰Ω†ÁöÑÊâãÊú∫Áõ∏ÂÜå",app_Name];
        
        UIAlertView* alertView= [[UIAlertView alloc] initWithTitle:nil message:tips delegate:self cancelButtonTitle:@"ÂÖ≥Èó≠" otherButtonTitles:nil];
        alertView.tag =1003;
        [alertView show];
    }

    CorePhotoPickerVCManager *manager=[CorePhotoPickerVCManager new];
    
    //ËÆæÁΩÆÁ±ªÂûã
    manager.pickerVCManagerType = CorePhotoPickerVCMangerTypeMultiPhoto;
    
    //ÊúÄÂ§öÂèØÈÄâ3Âº†
    manager.maxSelectedPhotoNumber = 9;
    
    //ÈîôËØØÂ§ÑÁêÜ
    if(manager.unavailableType!=CorePhotoPickerUnavailableTypeNone){
        NSLog(@"ËÆæÂ§á‰∏çÂèØÁî®");
        return;
    }
    
    UIViewController *pickerVC=manager.imagePickerController;

    //ÈÄâÂèñÁªìÊùü
    manager.finishPickingMedia=^(NSArray *medias){
        [ProgressUtil show];
        runOnBackground(^{
            [medias enumerateObjectsUsingBlock:^(CorePhoto *photo, NSUInteger idx, BOOL *stop) {
//                NSString * path = [photo.editedImage saveToLocal];
//                [ws.urls addObject:path];
                
            }];
            runOnMainThread(^{
//                [ws resetImageView];
                
                [ProgressUtil dismiss];
                
                NSLog(@"%ld", medias.count);
                
                for (CorePhoto *photo in medias) {
                    
                    NSLog(@"%@", photo);
                    
                    [_selectedPhotoArray addObject:photo.editedImage];
                    
                }
                NSLog(@"%ld", _selectedPhotoArray.count);
                
                [self uploadData];
                
            });
        });
        
    };
    if (self) {
        [self presentViewController:pickerVC animated:YES completion:nil];
    }else{
        [self presentViewController:pickerVC animated:YES completion:nil];
    }
    
}



- (void)sendMessage:(NSString *)message {
    
    UIAlertView *alertV = [[UIAlertView alloc] initWithTitle:message message:nil delegate:self cancelButtonTitle:@"ÂÆåÊàê" otherButtonTitles:nil,nil];
    alertV.tag = 1004;
    [alertV show];
}

-(void)alertView:(UIAlertView *)alertView clickedButtonAtIndex:(NSInteger)buttonIndex {
    if (alertView.tag == 1003) {
        if(buttonIndex==0){
            //ÂèñÊ∂àËÆæÁΩÆ
            [self dismissViewControllerAnimated:YES completion:nil];
            
        }
        
    }

//    if(buttonIndex == 0){
//        NSLog(@"ÁªßÁª≠‰∏ä‰º†");
//    }
    else  if(alertView.tag == 1004){
    if(buttonIndex == 0){
        NSLog(@"ÂÆåÊàê");
        [self.navigationController popViewControllerAnimated:YES];
    }
    
    }
}

- (void)didReceiveMemoryWarning {
    [super didReceiveMemoryWarning];
    // Dispose of any resources that can be recreated.
}

/*
#pragma mark - Navigation

// In a storyboard-based application, you will often want to do a little preparation before navigation
- (void)prepareForSegue:(UIStoryboardSegue *)segue sender:(id)sender {
    // Get the new view controller using [segue destinationViewController].
    // Pass the selected object to the new view controller.
}
*/

@end
